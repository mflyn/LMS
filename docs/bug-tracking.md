# Bug 跟踪文档

## 功能改进记录

### 改进 #001: 增加手机号注册功能

**日期**: 2024-12-19  
**类型**: 功能增强  
**优先级**: 中等  

#### 问题描述
当前系统只支持邮箱注册，限制了用户的注册方式选择。特别是对于移动端用户和家长用户，手机号注册更加便捷。

#### 解决方案
1. **数据模型更新**:
   - 修改User模型，将email字段改为可选
   - 添加phone字段支持手机号
   - 添加registrationType字段标识注册方式
   - 添加验证逻辑确保至少提供邮箱或手机号之一

2. **后端API更新**:
   - 更新注册验证规则，支持邮箱、手机号或混合注册
   - 添加邮箱或手机号登录接口
   - 更新认证控制器支持多种登录方式

3. **前端界面更新**:
   - 创建新的注册页面，支持三种注册方式选择
   - 更新登录页面，支持用户名或邮箱/手机号登录
   - 更新AuthContext支持新的登录方式

#### 修改文件列表
- `backend/common/models/User.js` - 用户模型更新
- `backend/common/middleware/requestValidator.js` - 验证规则更新
- `backend/services/auth-service/controllers/authController.js` - 认证控制器更新
- `backend/services/auth-service/routes/auth.js` - 路由更新
- `frontend/web/src/pages/Register.js` - 新建注册页面
- `frontend/web/src/pages/Login.js` - 登录页面更新
- `frontend/web/src/contexts/AuthContext.js` - 认证上下文更新
- `frontend/web/src/App.js` - 路由配置更新
- `docs/设计文档.md` - 设计文档更新

#### 测试要点
1. **注册功能测试**:
   - [ ] 邮箱注册功能正常
   - [ ] 手机号注册功能正常
   - [ ] 混合注册功能正常
   - [ ] 重复邮箱/手机号验证
   - [ ] 输入格式验证

2. **登录功能测试**:
   - [ ] 用户名登录功能正常
   - [ ] 邮箱登录功能正常
   - [ ] 手机号登录功能正常
   - [ ] 错误信息提示正确

3. **数据完整性测试**:
   - [ ] 用户数据正确保存
   - [ ] 注册类型正确标识
   - [ ] 索引正常工作

#### 状态
- [x] 设计文档更新
- [x] 后端模型更新
- [x] 后端API实现
- [x] 前端界面实现
- [ ] 单元测试
- [ ] 集成测试
- [ ] 用户验收测试

#### 备注
- 当前实现为基础版本，未包含邮箱/手机号验证功能
- 后续可考虑添加短信验证码和邮箱验证功能
- 需要更新相关测试用例以覆盖新功能

---

### 改进 #002: 配置管理和日志系统修复

**日期**: 2024-12-19  
**类型**: 技术债务修复  
**优先级**: 高  

#### 问题描述
代码评审发现以下问题：
1. 认证控制器中存在硬编码的JWT配置
2. 使用临时的console日志替代方案
3. 错误处理不够标准化
4. 配置管理不统一

#### 解决方案
1. **配置管理统一**:
   - 移除硬编码的JWT配置，使用configManager
   - 修复getServiceConfig方法，添加auth服务支持
   - 添加所有微服务的配置支持

2. **日志系统统一**:
   - 替换console日志为统一的winston logger
   - 添加结构化日志记录
   - 集成性能监控和错误追踪

3. **错误处理标准化**:
   - 使用catchAsync包装异步控制器
   - 抛出标准化错误而非直接返回响应
   - 完善不同类型错误的处理

4. **认证中间件优化**:
   - 使用configManager获取JWT密钥
   - 添加详细的日志记录
   - 增强错误消息的用户友好性

#### 修改文件列表
- `backend/services/auth-service/controllers/authController.js` - 移除硬编码，使用统一配置和日志
- `backend/common/middleware/auth.js` - 使用configManager，添加日志记录
- `backend/services/auth-service/app.js` - 集成日志中间件，添加健康检查
- `backend/common/config/index.js` - 修复getServiceConfig方法
- `backend/common/middleware/errorHandler.js` - 使用统一日志系统
- `docs/env-example.md` - 创建环境变量配置示例

#### 测试要点
1. **配置管理测试**:
   - [x] 配置验证功能正常
   - [x] 服务特定配置获取正常
   - [x] 环境变量正确加载

2. **日志系统测试**:
   - [x] 结构化日志输出正常
   - [x] 不同级别日志记录正确
   - [x] 性能监控日志工作

3. **错误处理测试**:
   - [x] 开发和生产环境错误响应不同
   - [x] 标准化错误格式
   - [x] 错误日志记录完整

4. **认证功能测试**:
   - [x] JWT令牌生成使用配置
   - [x] 认证过程日志记录
   - [x] 错误情况正确处理

#### 状态
- [x] 配置管理修复
- [x] 日志系统集成
- [x] 错误处理标准化
- [x] 认证中间件优化
- [x] 文档更新
- [ ] 性能测试
- [ ] 生产环境验证

#### 备注
- 所有服务现在使用统一的配置管理和日志系统
- 提升了系统的可维护性和可观测性
- 为后续的监控和运维奠定了基础

---

### 改进 #003: 本地集成测试环境配置

**日期**: 2024-01-01  
**类型**: 测试基础设施  
**优先级**: 高  

#### 问题描述
项目缺少完整的本地集成测试环境配置和自动化测试流程，导致：
1. 开发人员难以快速搭建测试环境
2. 缺少跨平台测试指南（Ubuntu虚拟机 + Mac + iPhone）
3. 手动测试效率低，容易遗漏测试项
4. 缺少标准化的测试流程和检查清单

#### 解决方案
1. **自动化测试脚本**:
   - 创建集成测试自动化脚本，支持一键环境配置
   - 自动检查依赖和环境配置
   - 支持多种测试模式（完整/跳过前端/性能测试）
   - 自动生成测试报告

2. **详细测试文档**:
   - 创建本地集成测试指南，覆盖三种平台配置
   - 提供快速测试指南，简化测试流程
   - 专门的iPhone测试指南，包含网络配置和故障排除

3. **测试环境标准化**:
   - 统一Docker Compose配置
   - 标准化环境变量配置
   - 网络配置和端口管理

4. **测试流程优化**:
   - 定义完整的测试检查清单
   - 提供测试场景和用例
   - 建立测试报告模板

#### 修改文件列表
- `scripts/integration-test.sh` - 自动化集成测试脚本
- `docs/本地集成测试指南.md` - 详细的集成测试指南
- `docs/快速测试指南.md` - 简化的测试步骤
- `docs/iPhone测试指南.md` - 移动端测试专门指南
- `docs/bug-tracking.md` - 更新bug跟踪记录

#### 测试要点
1. **环境配置测试**:
   - [ ] Ubuntu 24.04虚拟机环境配置
   - [ ] Docker和Docker Compose安装验证
   - [ ] 网络桥接模式配置
   - [ ] 端口占用检查和清理

2. **后端服务测试**:
   - [ ] 所有微服务启动成功
   - [ ] API健康检查通过
   - [ ] 数据库连接正常
   - [ ] Redis缓存工作正常

3. **前端服务测试**:
   - [ ] React开发服务器启动
   - [ ] API连接测试
   - [ ] 响应式布局验证
   - [ ] 跨域请求配置

4. **移动端测试**:
   - [ ] iPhone网络连接配置
   - [ ] Safari兼容性测试
   - [ ] 触摸操作测试
   - [ ] 性能和响应速度测试

5. **集成功能测试**:
   - [ ] 跨设备数据同步
   - [ ] 用户登录流程
   - [ ] 作业创建和提交流程
   - [ ] 实时通知功能

#### 脚本功能特性
- **智能环境检查**: 自动检查Docker、Node.js等依赖
- **端口管理**: 自动检测和处理端口占用
- **彩色日志**: 便于问题定位的日志输出
- **灵活配置**: 支持多种命令行参数
- **自动清理**: 测试完成后自动清理资源
- **报告生成**: 自动生成详细的测试报告

#### 网络配置支持
- **本地网络**: 支持同一WiFi网络下的设备通信
- **公网隧道**: 集成ngrok支持外网访问
- **IP地址管理**: 自动检测和配置IP地址
- **防火墙配置**: 提供防火墙配置指南

#### 状态
- [x] 自动化测试脚本开发
- [x] 详细测试文档编写
- [x] 网络配置指南
- [x] 故障排除指南
- [x] 测试检查清单
- [ ] 脚本实际环境测试
- [ ] 文档验证和优化
- [ ] CI/CD集成

#### 技术收益
1. **开发效率提升**: 一键测试环境搭建，节省配置时间
2. **测试覆盖完整**: 涵盖后端、前端、移动端全栈测试
3. **问题快速定位**: 详细的日志和报告，便于问题排查
4. **标准化流程**: 统一的测试流程和检查标准
5. **跨平台支持**: 支持不同操作系统和设备的测试

#### 下一步计划
- 在真实环境中验证测试脚本和文档
- 集成到CI/CD流水线中
- 添加更多自动化测试用例
- 扩展性能基准测试
- 建立测试数据管理机制

#### 备注
- 测试脚本支持Ubuntu 24.04、macOS和iOS设备
- 提供了多种网络配置方案，适应不同网络环境
- 文档详细程度适合不同技术水平的开发人员
- 为后续的持续集成和自动化测试奠定了基础

---

## Bug #004 - Docker 服务启动失败

### 问题描述
**发现日期**: 2024-12-20  
**报告人**: 用户  
**优先级**: 高  
**类型**: 环境配置问题  

在执行 `docker compose up -d` 时遇到网络连接错误：
```
Error response from daemon: Get "https://registry-1.docker.io/v2/": net/http: request canceled while waiting for connection
```

同时还有版本警告：
```
WARN[0000] the attribute `version` is obsolete, it will be ignored
```

### 根本原因
1. **网络连接问题**: Docker Hub 官方仓库连接超时，通常由以下原因导致：
   - 网络问题（特别是在中国大陆地区）
   - Docker Hub 访问限制
   - 未配置镜像加速器

2. **配置文件过时**: docker-compose.yml 使用了废弃的 version 字段

### 解决方案

#### 1. 配置 Docker 镜像源（推荐）
- 创建了自动配置脚本：`scripts/fix-docker-registry.sh`
- 配置多个国内镜像源：中科大、网易、百度云、腾讯云
- 自动重启 Docker 服务并验证配置

#### 2. 备用配置文件
- 创建了 `docker-compose.china.yml` 使用国内镜像
- 直接指定阿里云镜像仓库地址

#### 3. 详细文档
- 创建了完整的配置指南：`docs/Docker镜像源配置指南.md`
- 包含多种解决方案和故障排除步骤

#### 4. 配置文件优化
- 移除 docker-compose.yml 中废弃的 version 字段

### 修改文件
- `scripts/fix-docker-registry.sh` - 新建
- `docs/Docker镜像源配置指南.md` - 新建  
- `docker-compose.china.yml` - 新建
- `docker-compose.yml` - 移除废弃的 version 字段

### 使用方法

#### 方法1：自动配置脚本（推荐）
```bash
# 运行自动配置脚本
sudo ./scripts/fix-docker-registry.sh

# 验证配置
docker info | grep -A 10 "Registry Mirrors"

# 启动服务
docker compose up -d
```

#### 方法2：使用备用配置
```bash
# 如果主配置仍有问题，使用国内镜像配置
docker compose -f docker-compose.china.yml up -d
```

#### 方法3：手动配置
参考 `docs/Docker镜像源配置指南.md` 进行手动配置

### 测试要点
1. 运行配置脚本：`sudo ./scripts/fix-docker-registry.sh`
2. 验证镜像源配置：`docker info | grep -A 10 "Registry Mirrors"`
3. 测试镜像拉取：`docker pull hello-world`
4. 启动服务：`docker compose up -d`
5. 如果仍有问题，使用备用配置：`docker compose -f docker-compose.china.yml up -d`
6. 检查服务状态：`docker compose ps`

### 当前状态
- ✅ 解决方案已提供
- ✅ 自动化脚本已创建
- ✅ 备用配置已准备
- ✅ 详细文档已完成
- ⏳ 等待用户验证

### 备注
- 提供了多种备用方案确保问题能够解决
- 脚本支持自动备份原有配置
- 包含详细的故障排除指南
- 适用于各种网络环境和配置需求 